{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assign Courses | StudyPortal Admin</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .assignment-card {
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }
        
        .assignment-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        
        .priority-high { border-left-color: #ef4444; }
        .priority-medium { border-left-color: #f59e0b; }
        .priority-low { border-left-color: #10b981; }
        .priority-urgent { border-left-color: #dc2626; }
        
        .flatpickr-input {
            background-color: white !important;
        }
        
        .sidebar-gradient {
            background: linear-gradient(180deg, #4361ee 0%, #3a0ca3 100%);
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .course-card {
            transition: all 0.3s ease;
            border: 1px solid #e5e7eb;
        }
        
        .course-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            border-color: #3b82f6;
        }
        
        .progress-bar {
            height: 6px;
            border-radius: 3px;
            overflow: hidden;
            background-color: #e5e7eb;
        }
        
        .progress-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.5s ease;
        }
        
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .modal-overlay {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Navigation -->
    <!-- Enhanced Sidebar -->
<aside class="sidebar-gradient text-white w-64 fixed h-screen overflow-y-auto shadow-xl">
    <div class="p-6 border-b border-blue-400/30">
        <div class="flex items-center space-x-3">
            <div class="w-12 h-12 bg-white rounded-xl flex items-center justify-center shadow-lg">
                <i class="fas fa-graduation-cap text-blue-600 text-2xl"></i>
            </div>
            <div>
                <h2 class="text-xl font-bold">StudyPortal</h2>
                <p class="text-blue-200 text-xs">Admin Dashboard</p>
            </div>
        </div>
    </div>
    
    <nav class="flex-1 p-4 space-y-2">
        <a href="{% url 'admin_dashboard' %}" class="flex items-center space-x-3 p-3 text-blue-100 hover:bg-white/10 rounded-xl transition-all">
            <i class="fas fa-chart-line w-5 text-center"></i>
            <span>Dashboard</span>
        </a>
        <a href="{% url 'admin_students' %}" class="flex items-center space-x-3 p-3 text-blue-100 hover:bg-white/10 rounded-xl transition-all">
            <i class="fas fa-users w-5 text-center"></i>
            <span>Students</span>
        </a>
        <a href="{% url 'admin_courses' %}" class="flex items-center space-x-3 p-3 text-blue-100 hover:bg-white/10 rounded-xl transition-all">
            <i class="fas fa-book w-5 text-center"></i>
            <span>Courses</span>
        </a>
        
        <!-- MILESTONE 3 PROFESSIONAL FEATURES -->
        <a href="{% url 'assign_courses' %}" class="flex items-center space-x-3 p-3 bg-white/20 rounded-xl text-white font-medium">
            <i class="fas fa-tasks w-5 text-center"></i>
            <span>Assign Courses</span>
        </a>
        <!-- Add these 2 lines to your existing sidebar -->
        <a href="{% url 'admin_quizzes' %}" class="flex items-center space-x-3 p-3 text-blue-100 hover:bg-white/10 rounded-xl transition-all">
            <i class="fas fa-question-circle w-5 text-center"></i>
            <span>Quiz Management</span>
        </a>
        <a href="{% url 'admin_quiz_results' %}" class="flex items-center space-x-3 p-3 text-blue-100 hover:bg-white/10 rounded-xl transition-all">
            <i class="fas fa-chart-bar w-5 text-center"></i>
            <span>Quiz Results</span>
        </a>
        <a href="{% url 'student_study_tracks' %}" class="flex items-center space-x-3 p-3 text-blue-100 hover:bg-white/10 rounded-xl transition-all">
            <i class="fas fa-list-alt w-5 text-center"></i>
            <span>Study Tracks</span>
        </a>
        
        <a href="{% url 'admin_analytics' %}" class="flex items-center space-x-3 p-3 text-blue-100 hover:bg-white/10 rounded-xl transition-all">
            <i class="fas fa-chart-bar w-5 text-center"></i>
            <span>Analytics</span>
        </a>
    </nav>
    
    <div class="absolute bottom-0 left-0 right-0 p-4 border-t border-blue-400/30">
        <div class="bg-white/10 rounded-lg p-3 text-center">
            <p class="text-blue-200 text-sm">StudyPortal Pro</p>
            <p class="text-blue-300 text-xs">v2.0</p>
        </div>
    </div>
</aside>a

    <!-- Main Content -->
    <main class="ml-64 p-8">
        <!-- Header -->
        <div class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">Professional Course Assignment</h1>
                <p class="text-gray-600">Welcome back, {{ user.username }}! Assign courses with detailed scheduling and prioritization.</p>
            </div>
            <div class="flex items-center space-x-4">
                <div class="flex items-center space-x-2 text-sm text-gray-600">
                    <i class="fas fa-calendar-day text-blue-500"></i>
                    <span id="currentDate">Loading...</span>
                </div>
                <div class="flex items-center space-x-2 text-sm text-gray-600">
                    <i class="fas fa-clock text-green-500"></i>
                    <span id="currentTime">Loading...</span>
                </div>
                <div class="relative">
                    <button onclick="toggleProfileDropdown()" class="flex items-center space-x-3 bg-white px-4 py-2 rounded-xl shadow-lg border border-gray-200 hover:shadow-xl transition-all">
                        <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-white font-bold">
                            {{ user.username|first|upper }}
                        </div>
                        <div class="text-left">
                            <p class="font-semibold text-gray-900">{{ user.username }}</p>
                            <p class="text-xs text-gray-500">Administrator</p>
                        </div>
                        <i class="fas fa-chevron-down text-gray-400 text-sm"></i>
                    </button>
                    <div id="profileDropdown" class="hidden absolute right-0 mt-2 w-64 bg-white border border-gray-200 rounded-xl shadow-2xl z-50">
                        <div class="p-4 border-b">
                            <p class="font-semibold text-gray-900">{{ user.username }}</p>
                            <p class="text-sm text-gray-500">{{ user.email }}</p>
                        </div>
                        <div class="p-2">
                            <a href="{% url 'admin_profile_settings' %}" class="flex items-center space-x-3 px-3 py-2 rounded-lg hover:bg-gray-100 text-gray-700">
                                <i class="fas fa-user-cog text-blue-500 w-5"></i>
                                <span>Profile Settings</span>
                            </a>
                        </div>
                        <div class="p-2 border-t">
                            <form method="post" action="{% url 'admin_logout' %}" class="w-full">
                                {% csrf_token %}
                                <button type="submit" class="flex items-center space-x-3 px-3 py-2 rounded-lg hover:bg-red-50 text-red-600 w-full text-left">
                                    <i class="fas fa-sign-out-alt w-5"></i>
                                    <span>Logout</span>
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Messages -->
        {% if messages %}
        <div class="mb-6 space-y-2">
            {% for message in messages %}
            <div class="{% if message.tags == 'success' %}bg-green-50 border border-green-200 text-green-700{% else %}bg-red-50 border border-red-200 text-red-700{% endif %} rounded-lg p-4 flex items-center">
                <i class="fas {% if message.tags == 'success' %}fa-check-circle{% else %}fa-exclamation-circle{% endif %} mr-2"></i>
                <span>{{ message }}</span>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- Assignment Interface -->
        <div class="grid grid-cols-1 xl:grid-cols-3 gap-8">
            <!-- Student Selection & Course Management -->
            <div class="xl:col-span-2 space-y-6">
                <!-- Student Selection -->
                <div class="glass-card rounded-2xl p-6 fade-in">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">1. Select Student</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Choose Student</label>
                            <select id="studentSelect" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all">
                                <option value="">Select a student...</option>
                                {% for student in students %}
                                <option value="{{ student.id }}" data-email="{{ student.email }}" data-username="{{ student.username }}">
                                    {{ student.username }} - {{ student.email }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div id="studentInfo" class="bg-blue-50 p-4 rounded-lg hidden">
                            <div class="flex items-center space-x-3">
                                <div class="w-12 h-12 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-white font-bold">
                                    <span id="studentAvatar">U</span>
                                </div>
                                <div>
                                    <h3 class="font-semibold text-gray-900" id="studentName">Student Name</h3>
                                    <p class="text-sm text-gray-600" id="studentEmail">email@example.com</p>
                                    <p class="text-xs text-gray-500" id="currentAssignments">0 courses assigned</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Course Assignment Form -->
                <div id="assignmentForm" class="glass-card rounded-2xl p-6 fade-in hidden">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">2. Assign Course</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Select Course</label>
                            <select id="courseSelect" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all">
                                <option value="">Choose a course...</option>
                                {% for course in courses %}
                                <option value="{{ course.id }}" data-duration="{{ course.duration_weeks }}" data-name="{{ course.course_name|escapejs }}">
                                    {{ course.course_name }} ({{ course.duration_weeks }} weeks)
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Priority Level</label>
                            <select id="prioritySelect" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all">
                                <option value="low">Low Priority</option>
                                <option value="medium" selected>Medium Priority</option>
                                <option value="high">High Priority</option>
                                <option value="urgent">Urgent Priority</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Start Date</label>
                            <input type="text" id="startDate" class="date-picker w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all" placeholder="Select start date" readonly>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">End Date</label>
                            <input type="text" id="endDate" class="date-picker w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all" placeholder="Select end date" readonly>
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Assignment Notes (Optional)</label>
                        <textarea id="assignmentNotes" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all" rows="3" placeholder="Add any special instructions or notes for the student..."></textarea>
                    </div>
                    
                    <div class="flex justify-end space-x-4">
                        <button id="cancelAssignment" class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-all">
                            Cancel
                        </button>
                        <button id="assignCourseBtn" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-all font-medium">
                            <i class="fas fa-check-circle mr-2"></i>Assign Course
                        </button>
                    </div>
                </div>

                <!-- Current Assignments -->
                <div class="glass-card rounded-2xl p-6 fade-in">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-gray-900">Current Course Assignments</h2>
                        <button id="newAssignmentBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-all">
                            <i class="fas fa-plus mr-2"></i>New Assignment
                        </button>
                    </div>
                    
                    <div id="assignmentsList" class="space-y-4">
                        <div id="noAssignments" class="text-center py-8 text-gray-500">
                            <i class="fas fa-book-open text-4xl mb-3"></i>
                            <p>No courses assigned yet</p>
                            <p class="text-sm">Click "New Assignment" to assign a course</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Course Selection & Actions -->
            <div class="space-y-6">
                <!-- Available Courses -->
                <div class="glass-card rounded-2xl p-6 fade-in">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">Available Courses</h2>
                    <div class="space-y-4 max-h-96 overflow-y-auto pr-2">
                        {% for course in courses %}
                        <div class="course-card bg-white p-4 rounded-lg cursor-pointer transition-all"
                             onclick="selectCourse({{ course.id }}, '{{ course.course_name|escapejs }}', {{ course.duration_weeks }})">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <h3 class="font-medium text-gray-900">{{ course.course_name }}</h3>
                                    <div class="flex items-center space-x-4 text-sm text-gray-500 mt-1">
                                        <span><i class="fas fa-clock mr-1"></i>{{ course.duration_weeks }} weeks</span>
                                        <span><i class="fas fa-play-circle mr-1"></i>{{ course.videos.count }} videos</span>
                                    </div>
                                </div>
                                <i class="fas fa-plus-circle text-blue-500 text-lg mt-1"></i>
                            </div>
                        </div>
                        {% empty %}
                        <div class="text-center py-4 text-gray-500">
                            <i class="fas fa-book text-2xl mb-2"></i>
                            <p>No courses available</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Student Progress -->
                <div class="glass-card rounded-2xl p-6 fade-in">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">Student Progress</h2>
                    <div id="studentProgress" class="space-y-4">
                        <div class="text-center py-4 text-gray-500">
                            <i class="fas fa-user-graduate text-2xl mb-2"></i>
                            <p>Select a student to view progress</p>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="glass-card rounded-2xl p-6 fade-in">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">Quick Actions</h2>
                    <div class="space-y-2">
                        <button onclick="loadTemplate('balanced')" class="w-full text-left p-3 bg-purple-50 rounded-lg hover:bg-purple-100 transition-all">
                            <i class="fas fa-balance-scale text-purple-600 mr-2"></i>
                            <span class="font-medium">Balanced Workload Template</span>
                        </button>
                        <button onclick="loadTemplate('intensive')" class="w-full text-left p-3 bg-orange-50 rounded-lg hover:bg-orange-100 transition-all">
                            <i class="fas fa-fire text-orange-600 mr-2"></i>
                            <span class="font-medium">Intensive Learning Template</span>
                        </button>
                        <button onclick="loadTemplate('self_paced')" class="w-full text-left p-3 bg-green-50 rounded-lg hover:bg-green-100 transition-all">
                            <i class="fas fa-user-clock text-green-600 mr-2"></i>
                            <span class="font-medium">Self-Paced Template</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Success Modal -->
    <div id="successModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-2xl p-6 max-w-md w-full mx-4">
            <div class="text-center">
                <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-check text-green-600 text-2xl"></i>
                </div>
                <h3 class="text-xl font-semibold text-gray-900 mb-2" id="successTitle">Success!</h3>
                <p class="text-gray-600 mb-4" id="successMessage">Course assigned successfully</p>
                <button onclick="closeSuccessModal()" class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition-all">
                    Continue
                </button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="fixed inset-0 modal-overlay flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-2xl p-6 max-w-md w-full mx-4">
            <div class="text-center">
                <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-exclamation-triangle text-red-600 text-2xl"></i>
                </div>
                <h3 class="text-xl font-semibold text-gray-900 mb-2">Confirm Deletion</h3>
                <p class="text-gray-600 mb-4" id="deleteMessage">Are you sure you want to delete this assignment? This action cannot be undone.</p>
                <div class="flex space-x-3">
                    <button onclick="closeDeleteModal()" class="flex-1 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-all font-medium">
                        Cancel
                    </button>
                    <button id="confirmDeleteBtn" class="flex-1 bg-red-600 text-white py-3 rounded-lg hover:bg-red-700 transition-all font-medium">
                        Delete Assignment
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        const studentAssignments = {{ student_assignments|safe }};
        const today = '{{ today }}';
        const maxDate = '{{ max_date }}';
        let selectedStudentId = null;
        let selectedCourseId = null;
        let assignmentToDelete = null;

        // Initialize date pickers
        function initializeDatePickers() {
            flatpickr(".date-picker", {
                minDate: today,
                maxDate: maxDate,
                dateFormat: "Y-m-d",
                allowInput: true
            });
        }

        // Student selection handler
        document.getElementById('studentSelect').addEventListener('change', function() {
            selectedStudentId = this.value;
            const selectedOption = this.options[this.selectedIndex];
            const studentInfo = document.getElementById('studentInfo');
            const assignmentForm = document.getElementById('assignmentForm');
            const newAssignmentBtn = document.getElementById('newAssignmentBtn');

            if (selectedStudentId) {
                // Show student info
                const username = selectedOption.dataset.username;
                document.getElementById('studentName').textContent = username;
                document.getElementById('studentEmail').textContent = selectedOption.dataset.email;
                document.getElementById('studentAvatar').textContent = username.charAt(0).toUpperCase();
                
                // Load assignments from server for this student
                loadStudentAssignments(selectedStudentId);
                
                studentInfo.classList.remove('hidden');
                newAssignmentBtn.disabled = false;
            } else {
                studentInfo.classList.add('hidden');
                assignmentForm.classList.add('hidden');
                newAssignmentBtn.disabled = true;
                clearAssignmentsList();
                clearStudentProgress();
            }
        });

        // Load student assignments from server
       // Load student assignments from server
async function loadStudentAssignments(studentId) {
    try {
        const response = await fetch(`/api/student-assignments/${studentId}/`);
        const data = await response.json();
        
        if (data.success) {
            updateAssignmentsUI(data.assignments);
            updateStudentProgress(data.assignments);
            
            // Update assignment count
            const assignmentCount = data.assignments.length;
            document.getElementById('currentAssignments').textContent = `${assignmentCount} courses assigned`;
        } else {
            throw new Error(data.error || 'Failed to load assignments');
        }
    } catch (error) {
        console.error('Error loading assignments:', error);
        showTemporaryMessage('Error loading assignments: ' + error.message, 'error');
        // Fallback to static data if API fails
        const assignments = studentAssignments[studentId]?.assignments || [];
        updateAssignmentsUI(assignments);
        updateStudentProgress(assignments);
    }
}

// Delete assignment
async function deleteAssignment(assignmentId) {
    closeDeleteModal();
    
    try {
        // Show loading
        showTemporaryMessage('Deleting assignment...', 'info');
        
        const response = await fetch(`/api/assignments/${assignmentId}/delete/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            }
        });

        const data = await response.json();

        if (data.success) {
            showTemporaryMessage(data.message, 'success');
            
            // Remove assignment from UI
            const assignmentElement = document.querySelector(`[data-assignment-id="${assignmentId}"]`);
            if (assignmentElement) {
                assignmentElement.remove();
            }
            
            // Reload assignments to update counts and progress
            await loadStudentAssignments(selectedStudentId);
            
            // Show empty state if no assignments left
            const assignmentsList = document.getElementById('assignmentsList');
            if (assignmentsList.children.length === 0) {
                showNoAssignments();
            }
        } else {
            throw new Error(data.error || 'Failed to delete assignment');
        }
        
    } catch (error) {
        console.error('Error deleting assignment:', error);
        showTemporaryMessage('Failed to delete assignment: ' + error.message, 'error');
    }
}

// Update student progress with real data
function updateStudentProgress(assignments) {
    const progressElement = document.getElementById('studentProgress');
    
    if (!assignments || assignments.length === 0) {
        progressElement.innerHTML = `
            <div class="text-center py-4 text-gray-500">
                <i class="fas fa-user-graduate text-2xl mb-2"></i>
                <p>No assignments yet</p>
            </div>
        `;
        return;
    }
    
    const total = assignments.length;
    const completed = assignments.filter(a => a.status === 'completed').length;
    const inProgress = assignments.filter(a => a.status === 'in_progress').length;
    const notStarted = assignments.filter(a => a.status === 'not_started').length;
    
    // Calculate overall progress percentage
    const totalProgress = assignments.reduce((sum, assignment) => sum + (assignment.progress || 0), 0);
    const avgProgress = Math.round(totalProgress / assignments.length);
    
    let html = `
        <div class="space-y-4">
            <div>
                <div class="flex justify-between text-sm text-gray-600 mb-1">
                    <span>Overall Progress</span>
                    <span>${avgProgress}%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill bg-blue-600" style="width: ${avgProgress}%"></div>
                </div>
            </div>
            
            <div class="grid grid-cols-3 gap-2 text-center">
                <div class="bg-green-50 p-2 rounded-lg">
                    <p class="text-green-800 font-semibold">${completed}</p>
                    <p class="text-xs text-green-600">Completed</p>
                </div>
                <div class="bg-blue-50 p-2 rounded-lg">
                    <p class="text-blue-800 font-semibold">${inProgress}</p>
                    <p class="text-xs text-blue-600">In Progress</p>
                </div>
                <div class="bg-gray-50 p-2 rounded-lg">
                    <p class="text-gray-800 font-semibold">${notStarted}</p>
                    <p class="text-xs text-gray-600">Not Started</p>
                </div>
            </div>
            
            <div class="space-y-2">
                <p class="text-sm font-medium text-gray-700">Recent Activity</p>
                ${assignments.slice(0, 3).map(assignment => `
                    <div class="flex justify-between items-center text-sm">
                        <span class="truncate">${assignment.course_name}</span>
                        <span class="badge ${assignment.status === 'completed' ? 'bg-green-100 text-green-800' : 
                                          assignment.status === 'in_progress' ? 'bg-blue-100 text-blue-800' : 
                                          'bg-gray-100 text-gray-800'}">
                            ${assignment.progress}%
                        </span>
                    </div>
                `).join('')}
            </div>
        </div>
    `;
    
    progressElement.innerHTML = html;
}

        // Update assignments UI
        function updateAssignmentsUI(assignments) {
            clearAssignmentsList();
            
            if (assignments && assignments.length > 0) {
                assignments.forEach(assignment => {
                    addAssignmentToList(assignment);
                });
            } else {
                showNoAssignments();
            }
        }

        // Update student progress
        function updateStudentProgress(assignments) {
            const progressElement = document.getElementById('studentProgress');
            
            if (!assignments || assignments.length === 0) {
                progressElement.innerHTML = `
                    <div class="text-center py-4 text-gray-500">
                        <i class="fas fa-user-graduate text-2xl mb-2"></i>
                        <p>No assignments yet</p>
                    </div>
                `;
                return;
            }
            
            const total = assignments.length;
            const completed = assignments.filter(a => a.status === 'completed').length;
            const inProgress = assignments.filter(a => a.status === 'in_progress').length;
            const notStarted = assignments.filter(a => a.status === 'not_started').length;
            
            const completionRate = total > 0 ? Math.round((completed / total) * 100) : 0;
            
            let html = `
                <div class="space-y-4">
                    <div>
                        <div class="flex justify-between text-sm text-gray-600 mb-1">
                            <span>Overall Progress</span>
                            <span>${completionRate}%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill bg-blue-600" style="width: ${completionRate}%"></div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-2 text-center">
                        <div class="bg-green-50 p-2 rounded-lg">
                            <p class="text-green-800 font-semibold">${completed}</p>
                            <p class="text-xs text-green-600">Completed</p>
                        </div>
                        <div class="bg-blue-50 p-2 rounded-lg">
                            <p class="text-blue-800 font-semibold">${inProgress}</p>
                            <p class="text-xs text-blue-600">In Progress</p>
                        </div>
                        <div class="bg-gray-50 p-2 rounded-lg">
                            <p class="text-gray-800 font-semibold">${notStarted}</p>
                            <p class="text-xs text-gray-600">Not Started</p>
                        </div>
                    </div>
                </div>
            `;
            
            progressElement.innerHTML = html;
        }

        // Clear student progress
        function clearStudentProgress() {
            const progressElement = document.getElementById('studentProgress');
            progressElement.innerHTML = `
                <div class="text-center py-4 text-gray-500">
                    <i class="fas fa-user-graduate text-2xl mb-2"></i>
                    <p>Select a student to view progress</p>
                </div>
            `;
        }

        // New assignment button handler
        document.getElementById('newAssignmentBtn').addEventListener('click', function() {
            if (!selectedStudentId) {
                showTemporaryMessage('Please select a student first', 'warning');
                return;
            }
            
            document.getElementById('assignmentForm').classList.remove('hidden');
            resetAssignmentForm();
        });

        // Cancel assignment button handler
        document.getElementById('cancelAssignment').addEventListener('click', function() {
            document.getElementById('assignmentForm').classList.add('hidden');
            resetAssignmentForm();
        });

        // Select course from available courses
        function selectCourse(courseId, courseName, durationWeeks) {
            if (!selectedStudentId) {
                showTemporaryMessage('Please select a student first', 'warning');
                return;
            }
            
            // Show assignment form
            document.getElementById('assignmentForm').classList.remove('hidden');
            
            // Set course selection
            document.getElementById('courseSelect').value = courseId;
            selectedCourseId = courseId;
            
            // Set default dates based on course duration
            const startDate = new Date();
            const endDate = new Date();
            endDate.setDate(startDate.getDate() + (durationWeeks * 7));
            
            document.getElementById('startDate').value = formatDate(startDate);
            document.getElementById('endDate').value = formatDate(endDate);
        }

        // Assign course button handler
        document.getElementById('assignCourseBtn').addEventListener('click', function() {
            validateAndSubmitAssignment();
        });

        // Add assignment to the list
function addAssignmentToList(assignment) {
    const assignmentsList = document.getElementById('assignmentsList');
    const noAssignments = document.getElementById('noAssignments');
    
    if (noAssignments) {
        noAssignments.remove();
    }
    
    const priorityClass = `priority-${assignment.priority}`;
    const statusClass = assignment.status === 'completed' ? 'bg-green-100 text-green-800' : 
                      assignment.status === 'in_progress' ? 'bg-blue-100 text-blue-800' : 
                      'bg-gray-100 text-gray-800';
    
    // Progress bar for the assignment
    const progressBar = assignment.status === 'completed' ? 
        `<div class="w-full bg-green-200 rounded-full h-1.5"><div class="bg-green-600 h-1.5 rounded-full" style="width: 100%"></div></div>` :
        `<div class="w-full bg-gray-200 rounded-full h-1.5"><div class="bg-blue-600 h-1.5 rounded-full" style="width: ${assignment.progress}%"></div></div>`;
    
    const assignmentCard = `
        <div class="assignment-card ${priorityClass} bg-white p-4 rounded-lg border" data-assignment-id="${assignment.id}">
            <div class="flex justify-between items-start">
                <div class="flex-1">
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="font-semibold text-gray-900">${assignment.course_name}</h3>
                        <span class="badge ${statusClass}">${assignment.status.replace('_', ' ')}</span>
                    </div>
                    
                    <div class="mb-2">
                        <div class="flex justify-between text-sm text-gray-600 mb-1">
                            <span>Progress: ${assignment.progress}%</span>
                            <span>${assignment.watched_videos}/${assignment.total_videos} videos</span>
                        </div>
                        ${progressBar}
                    </div>
                    
                    <div class="flex items-center space-x-4 text-sm text-gray-500">
                        <span><i class="fas fa-flag mr-1"></i>${assignment.priority}</span>
                        <span><i class="fas fa-calendar-alt mr-1"></i>${assignment.start_date} to ${assignment.end_date}</span>
                    </div>
                    ${assignment.notes ? `<p class="text-sm text-gray-600 mt-2">${assignment.notes}</p>` : ''}
                </div>
                <div class="flex space-x-2 ml-4">
                    <button onclick="editAssignment(${assignment.id})" class="text-blue-600 hover:text-blue-800 transition-colors p-1 rounded">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button onclick="showDeleteModal(${assignment.id}, '${assignment.course_name.replace(/'/g, "\\'")}')" class="text-red-600 hover:text-red-800 transition-colors p-1 rounded">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        </div>
    `;
    
    assignmentsList.insertAdjacentHTML('beforeend', assignmentCard);
}

        // Clear assignments list
        function clearAssignmentsList() {
            const assignmentsList = document.getElementById('assignmentsList');
            assignmentsList.innerHTML = '';
            showNoAssignments();
        }

        // Show no assignments message
        function showNoAssignments() {
            const assignmentsList = document.getElementById('assignmentsList');
            assignmentsList.innerHTML = `
                <div id="noAssignments" class="text-center py-8 text-gray-500">
                    <i class="fas fa-book-open text-4xl mb-3"></i>
                    <p>No courses assigned yet</p>
                    <p class="text-sm">Click "New Assignment" to assign a course</p>
                </div>
            `;
        }

        // Reset assignment form
        function resetAssignmentForm() {
            document.getElementById('courseSelect').value = '';
            document.getElementById('prioritySelect').value = 'medium';
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            document.getElementById('assignmentNotes').value = '';
            selectedCourseId = null;
        }

        // Format date to YYYY-MM-DD
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Validate and submit assignment
        async function validateAndSubmitAssignment() {
            if (!selectedStudentId) {
                showTemporaryMessage('Please select a student first', 'error');
                return;
            }
            
            const courseId = document.getElementById('courseSelect').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const priority = document.getElementById('prioritySelect').value;
            const notes = document.getElementById('assignmentNotes').value;
            
            // Validation
            if (!courseId) {
                showTemporaryMessage('Please select a course', 'error');
                return;
            }
            
            if (!startDate || !endDate) {
                showTemporaryMessage('Please set start and end dates', 'error');
                return;
            }
            
            if (new Date(startDate) >= new Date(endDate)) {
                showTemporaryMessage('End date must be after start date', 'error');
                return;
            }
            
            await submitAssignment(courseId, startDate, endDate, priority, notes);
        }

        // Submit assignment to server
        async function submitAssignment(courseId, startDate, endDate, priority, notes) {
            const assignButton = document.getElementById('assignCourseBtn');
            
            // Show loading state
            assignButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Assigning...';
            assignButton.disabled = true;
            
            try {
                const response = await fetch('{% url "save_course_assignments" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({
                        student_id: selectedStudentId,
                        assignments: [{
                            course_id: courseId,
                            start_date: startDate,
                            end_date: endDate,
                            priority: priority,
                            notes: notes
                        }]
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showSuccessModal(
                        'Assignment Successful!',
                        `Course "${data.assigned_courses[0].course_name}" has been assigned successfully`,
                        data.assigned_courses
                    );
                    
                    // Reset form and update UI
                    document.getElementById('assignmentForm').classList.add('hidden');
                    resetAssignmentForm();
                    
                    // Reload assignments to get updated status
                    await loadStudentAssignments(selectedStudentId);
                } else {
                    let errorMessage = data.error || 'Unknown error occurred';
                    if (data.details) {
                        errorMessage += '\n\n' + data.details.join('\n');
                    }
                    showTemporaryMessage('Assignment failed: ' + errorMessage, 'error');
                }
                
            } catch (error) {
                console.error('Error submitting assignment:', error);
                showTemporaryMessage('Network error: Failed to assign course. Please try again.', 'error');
            } finally {
                // Reset button
                assignButton.innerHTML = '<i class="fas fa-check-circle mr-2"></i>Assign Course';
                assignButton.disabled = false;
            }
        }

        // Edit assignment
        function editAssignment(assignmentId) {
            // Find the assignment in current assignments
            const assignmentElement = document.querySelector(`[data-assignment-id="${assignmentId}"]`);
            if (!assignmentElement) return;
            
            // Extract assignment data (you might want to fetch from server for accurate data)
            const assignmentName = assignmentElement.querySelector('h3').textContent;
            
            // Show assignment form with existing data
            document.getElementById('assignmentForm').classList.remove('hidden');
            
            // For now, just show a message - you would implement full edit functionality
            showTemporaryMessage(`Edit functionality for "${assignmentName}" would be implemented here`, 'info');
        }

        // Show delete confirmation modal
        function showDeleteModal(assignmentId, courseName) {
            assignmentToDelete = assignmentId;
            document.getElementById('deleteMessage').textContent = 
                `Are you sure you want to delete the assignment for "${courseName}"? This action cannot be undone.`;
            document.getElementById('deleteModal').classList.remove('hidden');
            
            // Set up confirm delete button
            document.getElementById('confirmDeleteBtn').onclick = function() {
                deleteAssignment(assignmentId);
            };
        }

        // Close delete modal
        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.add('hidden');
            assignmentToDelete = null;
        }

        // Delete assignment
        async function deleteAssignment(assignmentId) {
            closeDeleteModal();
            
            try {
                // Show loading
                showTemporaryMessage('Deleting assignment...', 'info');
                
                // This would be your actual API endpoint for deletion
                const response = await fetch(`/api/assignments/${assignmentId}/delete/`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}'
                    }
                });

                if (response.ok) {
                    showTemporaryMessage('Assignment deleted successfully', 'success');
                    
                    // Remove assignment from UI
                    const assignmentElement = document.querySelector(`[data-assignment-id="${assignmentId}"]`);
                    if (assignmentElement) {
                        assignmentElement.remove();
                    }
                    
                    // Reload assignments to update counts and progress
                    await loadStudentAssignments(selectedStudentId);
                } else {
                    throw new Error('Failed to delete assignment');
                }
                
            } catch (error) {
                console.error('Error deleting assignment:', error);
                showTemporaryMessage('Failed to delete assignment. Please try again.', 'error');
            }
        }

        // Show temporary message
        function showTemporaryMessage(message, type = 'info') {
            // Remove any existing temporary messages
            const existingMessage = document.getElementById('temporaryMessage');
            if (existingMessage) {
                existingMessage.remove();
            }
            
            const bgColor = type === 'error' ? 'bg-red-50 border-red-200 text-red-700' :
                          type === 'success' ? 'bg-green-50 border-green-200 text-green-700' :
                          type === 'warning' ? 'bg-yellow-50 border-yellow-200 text-yellow-700' :
                          'bg-blue-50 border-blue-200 text-blue-700';
            
            const icon = type === 'error' ? 'fa-exclamation-circle' :
                       type === 'success' ? 'fa-check-circle' :
                       type === 'warning' ? 'fa-exclamation-triangle' :
                       'fa-info-circle';
            
            const messageElement = document.createElement('div');
            messageElement.id = 'temporaryMessage';
            messageElement.className = `${bgColor} border rounded-lg p-4 flex items-center mb-4 fade-in`;
            messageElement.innerHTML = `
                <i class="fas ${icon} mr-2"></i>
                <span>${message}</span>
            `;
            
            // Insert after messages or at top of main content
            const messagesContainer = document.querySelector('.mb-6.space-y-2') || document.querySelector('main');
            messagesContainer.parentNode.insertBefore(messageElement, messagesContainer.nextSibling);
            
            // Remove message after 5 seconds
            setTimeout(() => {
                if (messageElement.parentNode) {
                    messageElement.remove();
                }
            }, 5000);
        }

        // Show success modal
        function showSuccessModal(title, message, assignedCourses) {
            document.getElementById('successTitle').textContent = title;
            document.getElementById('successMessage').textContent = message;
            document.getElementById('successModal').classList.remove('hidden');
        }

        // Close success modal
        function closeSuccessModal() {
            document.getElementById('successModal').classList.add('hidden');
        }

        // Template functions
        function loadTemplate(templateType) {
            if (!selectedStudentId) {
                showTemporaryMessage('Please select a student first', 'warning');
                return;
            }
            
            showTemporaryMessage(`Loading ${templateType} template would be implemented here`, 'info');
        }

        // Profile dropdown functionality
        function toggleProfileDropdown() {
            const dropdown = document.getElementById("profileDropdown");
            dropdown.classList.toggle("hidden");
        }

        // Close dropdown when clicking outside
        document.addEventListener("click", function(event) {
            const dropdown = document.getElementById("profileDropdown");
            const button = document.querySelector('[onclick="toggleProfileDropdown()"]');
            if (dropdown && button && !dropdown.contains(event.target) && !button.contains(event.target)) {
                dropdown.classList.add("hidden");
            }
        });

        // Update date and time
        function updateDateTime() {
            const now = new Date();
            document.getElementById('currentDate').textContent = now.toLocaleDateString('en-US', { 
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
            });
            document.getElementById('currentTime').textContent = now.toLocaleTimeString('en-US', {
                hour: '2-digit', minute: '2-digit', second: '2-digit'
            });
        }

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            initializeDatePickers();
            updateDateTime();
            setInterval(updateDateTime, 1000);
            
            console.log('Professional Course Assignment System Initialized');
        });
    </script>
</body>
</html>