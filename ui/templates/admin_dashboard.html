{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard | StudyPortal</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Add the Inter font import -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --primary: #4361ee;
      --secondary: #3f37c9;
      --success: #4cc9f0;
      --warning: #f72585;
      --light: #f8f9fa;
      --dark: #212529;
    }
    
    body {
      background: linear-gradient(135deg, #f5f7ff 0%, #f0f4ff 100%);
      font-family: 'Inter', sans-serif; /* Updated font family */
    }
    
    .glass-card {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow: 0 8px 32px rgba(31, 38, 135, 0.1);
    }
    
    .sidebar-gradient {
      background: linear-gradient(180deg, #4361ee 0%, #3a0ca3 100%);
    }
    
    .gradient-text {
      background: linear-gradient(135deg, var(--primary), var(--success));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    .hover-lift {
      transition: all 0.3s ease;
    }
    
    .hover-lift:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 40px rgba(0,0,0,0.15);
    }

    /* Add this to your existing CSS */


/* Ensure chart containers maintain consistent height */
.chart-container {
  position: relative;
  height: 280px;
  width: 100%;
  min-height: 280px;
  flex:1;
}
/* Add to your existing CSS */
.chart-grid > div {
  display: flex;
  flex-direction: column;
}

.chart-container {
  flex: 1;
  min-height: 280px;
}

/* Fix for chart responsiveness */
canvas {
  display: block;
  max-width: 100%;
}

/* Loading states for charts */
.chart-loading {
  display: flex;
  align-items: center;
  justify-content: center;
  height: 100%;
  color: #6b7280;
}

/* Ensure proper chart rendering */
.chart-wrapper {
  position: relative;
  width: 100%;
}
    
    
  </style>
</head>

<body class="text-gray-800 antialiased">
<div class="flex min-h-screen">

  <!-- Enhanced Sidebar -->
  <aside class="sidebar-gradient text-white w-64 fixed h-screen overflow-y-auto shadow-xl">
    <div class="p-6 border-b border-blue-400/30">
      <div class="flex items-center space-x-3">
        <div class="w-12 h-12 bg-white rounded-xl flex items-center justify-center shadow-lg">
          <i class="fas fa-graduation-cap text-blue-600 text-2xl"></i>
        </div>
        <div>
          <h2 class="text-xl font-bold">StudyPortal</h2>
          <p class="text-blue-200 text-xs">Admin Dashboard</p>
        </div>
      </div>
    </div>
    
    <nav class="flex-1 p-4 space-y-2">
      <a href="{% url 'admin_dashboard' %}" class="flex items-center space-x-3 p-3 bg-white/20 rounded-xl text-white font-medium">
        <i class="fas fa-chart-line w-5 text-center"></i>
        <span>Dashboard</span>
      </a>
      <a href="{% url 'admin_students' %}" class="flex items-center space-x-3 p-3 text-blue-100 hover:bg-white/10 rounded-xl transition-all">
        <i class="fas fa-users w-5 text-center"></i>
        <span>Students</span>
      </a>
      <a href="{% url 'admin_courses' %}" class="flex items-center space-x-3 p-3 text-blue-100 hover:bg-white/10 rounded-xl transition-all">
        <i class="fas fa-book w-5 text-center"></i>
        <span>Courses</span>
      </a>
      
      <!-- MILESTONE 3 PROFESSIONAL FEATURES -->
      <a href="{% url 'assign_courses' %}" class="flex items-center space-x-3 p-3 text-blue-100 hover:bg-white/10 rounded-xl transition-all">
        <i class="fas fa-tasks w-5 text-center"></i>
        <span>Assign Courses</span>
      </a>
      <!-- Add these 2 lines to your existing sidebar -->
       <a href="{% url 'admin_quizzes' %}" class="flex items-center space-x-3 p-3 text-blue-100 hover:bg-white/10 rounded-xl transition-all">
        <i class="fas fa-question-circle w-5 text-center"></i>
        <span>Quiz Management</span>
       </a>
      <a href="{% url 'admin_quiz_results' %}" class="flex items-center space-x-3 p-3 text-blue-100 hover:bg-white/10 rounded-xl transition-all">
        <i class="fas fa-chart-bar w-5 text-center"></i>
        <span>Quiz Results</span>
      </a>
      <a href="{% url 'student_study_tracks' %}" class="flex items-center space-x-3 p-3 text-blue-100 hover:bg-white/10 rounded-xl transition-all">
        <i class="fas fa-list-alt w-5 text-center"></i>
        <span>Study Tracks</span>
      </a>
      
      <a href="{% url 'admin_analytics' %}" class="flex items-center space-x-3 p-3 text-blue-100 hover:bg-white/10 rounded-xl transition-all">
        <i class="fas fa-chart-bar w-5 text-center"></i>
        <span>Analytics</span>
      </a>
    </nav>
    
    <div class="absolute bottom-0 left-0 right-0 p-4 border-t border-blue-400/30">
      <div class="bg-white/10 rounded-lg p-3 text-center">
        <p class="text-blue-200 text-sm">StudyPortal Pro</p>
        <p class="text-blue-300 text-xs">v2.0</p>
      </div>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="ml-64 p-8">

    <!-- Enhanced Header -->
    <div class="flex justify-between items-center mb-8">
      <div>
        <h1 class="text-4xl font-bold text-gray-900 mb-2">Admin Dashboard</h1>
        <div class="flex items-center space-x-4 text-sm text-gray-600">
          <span class="flex items-center space-x-1">
            <i class="fas fa-calendar-day text-blue-500"></i>
            <span id="currentDate">{{ current_date }}</span>
          </span>
          <span class="flex items-center space-x-1">
            <i class="fas fa-clock text-green-500"></i>
            <span id="currentTime">{{ current_time }}</span>
          </span>
          <span class="flex items-center space-x-1">
            <i class="fas fa-user-shield text-purple-500"></i>
            <span>Administrator</span>
          </span>
        </div>
      </div>

      <!-- Updated Profile Dropdown to match student_study_tracks.html -->
      <div class="flex space-x-4">
        <a href="{% url 'assign_courses' %}" class="bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700 transition-all">
          <i class="fas fa-plus mr-2"></i>Assign Courses
        </a>
        <div class="relative">
          <button onclick="toggleProfileDropdown()" class="flex items-center space-x-3 bg-white px-4 py-2 rounded-xl shadow-lg border border-gray-200 hover:shadow-xl transition-all">
            <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-white font-bold">
              {{ user.username|first|upper }}
            </div>
            <div class="text-left">
              <p class="font-semibold text-gray-900">{{ user.username }}</p>
              <p class="text-xs text-gray-500">Administrator</p>
            </div>
            <i class="fas fa-chevron-down text-gray-400 text-sm"></i>
          </button>
          <div id="profileDropdown" class="hidden absolute right-0 mt-2 w-64 bg-white border border-gray-200 rounded-xl shadow-2xl z-50">
            <div class="p-4 border-b">
              <p class="font-semibold text-gray-900">{{ user.username }}</p>
              <p class="text-sm text-gray-500">{{ user.email }}</p>
            </div>
            <div class="p-2">
              <a href="{% url 'admin_profile_settings' %}" class="flex items-center space-x-3 px-3 py-2 rounded-lg hover:bg-gray-100 text-gray-700">
                <i class="fas fa-user-cog text-blue-500 w-5"></i>
                <span>Profile Settings</span>
              </a>
            </div>
            <div class="p-2 border-t">
              <form method="post" action="{% url 'admin_logout' %}" class="w-full">{% csrf_token %}
                <button type="submit" class="flex items-center space-x-3 px-3 py-2 rounded-lg hover:bg-red-50 text-red-600 w-full text-left">
                  <i class="fas fa-sign-out-alt w-5"></i>
                  <span>Logout</span>
                </button>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Messages Section -->
    {% if messages %}
    <div class="mb-6">
      {% for message in messages %}
      <div class="{% if message.tags == 'success' %}bg-green-50 border border-green-200 text-green-700{% else %}bg-red-50 border border-red-200 text-red-700{% endif %} rounded-lg p-4 mb-2">
        <div class="flex items-center">
          <i class="fas {% if message.tags == 'success' %}fa-check-circle{% else %}fa-exclamation-circle{% endif %} mr-2"></i>
          <span>{{ message }}</span>
        </div>
      </div>
      {% endfor %}
    </div>
    {% endif %}

    <!-- Quick Stats Row -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
      <!-- Total Students -->
      <div class="glass-card p-6 rounded-2xl hover-lift group">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-500 font-medium mb-1">Total Students</p>
            <p id="total_students" class="text-3xl font-bold text-gray-900 mb-2">0</p>
            <div class="flex items-center text-sm text-green-600">
              <i class="fas fa-users mr-1"></i>
              <span id="student_growth">Registered students</span>
            </div>
          </div>
          <div class="bg-blue-100 p-4 rounded-2xl group-hover:bg-blue-200 transition-colors">
            <i class="fas fa-users text-blue-600 text-2xl"></i>
          </div>
        </div>
      </div>

      <!-- Total Courses -->
      <div class="glass-card p-6 rounded-2xl hover-lift group">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-500 font-medium mb-1">Total Courses</p>
            <p id="total_courses" class="text-3xl font-bold text-gray-900 mb-2">0</p>
            <div class="flex items-center text-sm text-blue-600">
              <i class="fas fa-book mr-1"></i>
              <span id="active_courses">Available courses</span>
            </div>
          </div>
          <div class="bg-green-100 p-4 rounded-2xl group-hover:bg-green-200 transition-colors">
            <i class="fas fa-book-open text-green-600 text-2xl"></i>
          </div>
        </div>
      </div>

      <!-- Assignments Pending -->
      <div class="glass-card p-6 rounded-2xl hover-lift group">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-500 font-medium mb-1">Pending Assignments</p>
            <p id="pending_assignments" class="text-3xl font-bold text-gray-900 mb-2">0</p>
            <div class="flex items-center text-sm text-orange-600">
              <i class="fas fa-clock mr-1"></i>
              <span>Require attention</span>
            </div>
          </div>
          <div class="bg-orange-100 p-4 rounded-2xl group-hover:bg-orange-200 transition-colors">
            <i class="fas fa-tasks text-orange-600 text-2xl"></i>
          </div>
        </div>
      </div>

      <!-- System Health -->
      <div class="glass-card p-6 rounded-2xl hover-lift group">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-500 font-medium mb-1">System Health</p>
            <p id="system_health" class="text-3xl font-bold text-green-600 mb-2">100%</p>
            <div class="flex items-center text-sm text-green-600">
              <i class="fas fa-check-circle mr-1"></i>
              <span>All systems operational</span>
            </div>
          </div>
          <div class="bg-purple-100 p-4 rounded-2xl group-hover:bg-purple-200 transition-colors">
            <i class="fas fa-heartbeat text-purple-600 text-2xl"></i>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Content Grid -->
    <div class="grid grid-cols-1  gap-8 mb-8">
      <!-- User Study Overview -->
      <div class="glass-card rounded-2xl p-6 shadow xl:col-span-2">
        <div class="flex justify-between items-center mb-6">
          <div>
            <h2 class="text-xl font-bold text-gray-900">User Study Overview</h2>
            <p class="text-gray-500 text-sm">Monitor student progress and course assignments</p>
          </div>
          <div class="flex space-x-2">
            <a href="{% url 'student_study_tracks' %}" class="bg-blue-100 text-blue-700 px-4 py-2 rounded-lg text-sm font-medium hover:bg-blue-200 transition-colors">
              <i class="fas fa-list-alt mr-2"></i>View All Tracks
            </a>
            <button onclick="refreshData()" class="bg-gray-100 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-200 transition-colors">
              <i class="fas fa-sync-alt mr-2"></i>Refresh
            </button>
          </div>
        </div>
        <div class="overflow-x-auto rounded-xl border border-gray-200">
          <table class="min-w-full">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Student</th>
                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Course</th>
                <th class="px-6 py-4 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider">Duration</th>
                <th class="px-6 py-4 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider">Progress</th>
                <th class="px-6 py-4 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider">Status</th>
              </tr>
            </thead>
            <tbody id="user_study_tbody" class="bg-white divide-y divide-gray-200">
              <tr>
                <td colspan="5" class="px-6 py-8 text-center text-gray-500">
                  <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                  <p>Loading study data...</p>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      <!-- Quick Actions & System Stats -->
<div class="space-y-8">
  <!-- Quick Actions -->
  <div class="glass-card rounded-2xl p-6 shadow">
    <h2 class="text-xl font-bold text-gray-900 mb-4">Quick Actions</h2>
    <div class="grid grid-cols-2 gap-4">
      <!-- Assign Course -->
      <a href="{% url 'assign_courses' %}" class="bg-blue-50 border border-blue-200 rounded-xl p-4 text-center hover:bg-blue-100 transition-colors group">
        <i class="fas fa-user-plus text-blue-600 text-2xl mb-2"></i>
        <p class="font-semibold text-blue-900">Assign Course</p>
        <p class="text-xs text-blue-600 mt-1">To Student</p>
      </a>
      
      <!-- Create Quiz -->
      <a href="{% url 'admin_create_quiz' %}" class="bg-purple-50 border border-purple-200 rounded-xl p-4 text-center hover:bg-purple-100 transition-colors group">
        <i class="fas fa-plus-circle text-purple-600 text-2xl mb-2"></i>
        <p class="font-semibold text-purple-900">Create Quiz</p>
        <p class="text-xs text-purple-600 mt-1">New assessment</p>
      </a>
      
      <!-- Manage Quizzes -->
      <a href="{% url 'admin_quizzes' %}" class="bg-green-50 border border-green-200 rounded-xl p-4 text-center hover:bg-green-100 transition-colors group">
        <i class="fas fa-question-circle text-green-600 text-2xl mb-2"></i>
        <p class="font-semibold text-green-900">Manage</p>
        <p class="text-xs text-green-600 mt-1">Quizzes</p>
      </a>
      
      <!-- Quiz Reminders -->
      
      <!-- Add Course -->
      <a href="{% url 'add_course' %}" class="bg-green-50 border border-green-200 rounded-xl p-4 text-center hover:bg-green-100 transition-colors group">
        <i class="fas fa-plus-circle text-green-600 text-2xl mb-2"></i>
        <p class="font-semibold text-green-900">Add Course</p>
        <p class="text-xs text-green-600 mt-1">New content</p>
      </a>
      
      <!-- Manage Students -->
      <a href="{% url 'admin_students' %}" class="bg-purple-50 border border-purple-200 rounded-xl p-4 text-center hover:bg-purple-100 transition-colors group">
        <i class="fas fa-user-graduate text-purple-600 text-2xl mb-2"></i>
        <p class="font-semibold text-purple-900">Manage</p>
        <p class="text-xs text-purple-600 mt-1">Students</p>
      </a>
      
      <!-- Reports -->
      <a href="{% url 'admin_analytics' %}" class="bg-orange-50 border border-orange-200 rounded-xl p-4 text-center hover:bg-orange-100 transition-colors group">
        <i class="fas fa-chart-pie text-orange-600 text-2xl mb-2"></i>
        <p class="font-semibold text-orange-900">Reports</p>
        <p class="text-xs text-orange-600 mt-1">Generate</p>
      </a>
    </div>
  </div>

  <!-- System Status -->
  <div class="glass-card rounded-2xl p-6 shadow">
    <h2 class="text-xl font-bold text-gray-900 mb-4">System Status</h2>
    <div class="space-y-4">
      <div class="flex justify-between items-center">
        <span class="text-gray-700">Database</span>
        <span class="flex items-center text-green-600">
          <i class="fas fa-circle text-xs mr-2"></i>
          Operational
        </span>
      </div>
      <div class="flex justify-between items-center">
        <span class="text-gray-700">API Services</span>
        <span class="flex items-center text-green-600">
          <i class="fas fa-circle text-xs mr-2"></i>
          Running
        </span>
      </div>
      <div class="flex justify-between items-center">
        <span class="text-gray-700">Storage</span>
        <span class="flex items-center text-blue-600">
          <i class="fas fa-circle text-xs mr-2"></i>
          68% Used
        </span>
      </div>
      <div class="flex justify-between items-center">
        <span class="text-gray-700">Last Backup</span>
        <span class="flex items-center text-gray-600 text-sm">
          2 hours ago
        </span>
      </div>
    </div>
  </div>
</div>



    <!-- Charts Section - Enhanced Professional Grid Layout -->
    <div class="mb-8">
      <div class="flex justify-between items-center mb-6">
        <div>
          <h2 class="text-2xl font-bold text-gray-900">Learning Analytics</h2>
          <p class="text-gray-500">Comprehensive overview of student performance and progress</p>
        </div>
        <div class="flex space-x-2">
          
          <button onclick="toggleChartView()" id="chartViewToggle" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-blue-700 transition-colors">
            <i class="fas fa-chart-bar mr-2"></i>Detailed View
          </button>
        </div>
      </div>
      
      <div class="grid grid-cols-1 x1:grid-cols-2 gap-6 chart-grid">
        <!-- Study Time Analytics -->
        <div class="glass-card rounded-2xl p-6 shadow hover-lift">
          <div class="flex justify-between items-center mb-4">
            <div>
              <h3 class="text-lg font-bold text-gray-900">Study Time Analytics</h3>
              <p class="text-gray-500 text-sm">Average study duration per user</p>
            </div>
            <div class="flex space-x-4">
              <div class="bg-blue-100 text-blue-700 px-3 py-2 rounded-lg">
                <p class="text-xs font-medium">Average</p>
                <p id="avgStudyTime" class="text-lg font-bold">0 min</p>
              </div>
            </div>
          </div>
          <div class="chart-container">
            <canvas id="studyChart"></canvas>
          </div>
          <div class="mt-4 flex justify-between text-sm text-gray-500">
            <span>Top Performer: <span id="topPerformer" class="font-medium text-gray-700">-</span></span>
            <span>Total Study Time: <span id="totalStudyTime" class="font-medium text-gray-700">0 min</span></span>
          </div>
        </div>

        <!-- Progress Distribution -->
        <div class="glass-card rounded-2xl p-6 shadow hover-lift">
          <div class="flex justify-between items-center mb-4">
            <div>
              <h3 class="text-lg font-bold text-gray-900">Progress Distribution</h3>
              <p class="text-gray-500 text-sm">Course completion rates</p>
            </div>
            <div class="flex space-x-4">
              <div class="bg-green-100 text-green-700 px-3 py-2 rounded-lg">
                <p class="text-xs font-medium">Avg. Completion</p>
                <p id="avgCompletion" class="text-lg font-bold">0%</p>
              </div>
            </div>
          </div>
          <div class="chart-container">
            <canvas id="progressChart"></canvas>
          </div>
          <div class="mt-4 flex justify-between text-sm text-gray-500">
            <span>Completion Rate: <span id="completionRate" class="font-medium text-gray-700">0%</span></span>
            <span>Active Learners: <span id="activeLearners" class="font-medium text-gray-700">0</span></span>
          </div>
        </div>
      </div>
    </div>

  </main>
</div>

<script>
function toggleProfileDropdown() {
  const dropdown = document.getElementById("profileDropdown");
  dropdown.classList.toggle("hidden");
}

// Close dropdown when clicking outside
document.addEventListener("click", function(event) {
  const dropdown = document.getElementById("profileDropdown");
  const button = document.querySelector('[onclick="toggleProfileDropdown()"]');
  if (dropdown && button && !dropdown.contains(event.target) && !button.contains(event.target)) {
    dropdown.classList.add("hidden");
  }
});

// Update current time
function updateDateTime() {
  const now = new Date();
  document.getElementById('currentDate').textContent = now.toLocaleDateString('en-US', { 
    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
  });
  document.getElementById('currentTime').textContent = now.toLocaleTimeString('en-US', {
    hour: '2-digit', minute: '2-digit'
  });
}

setInterval(updateDateTime, 1000);
updateDateTime();

// Global chart instances
let studyChartInstance = null;
let progressChartInstance = null;

// Safe data extraction with multiple fallback options
function getSafeData(item, field, defaultValue = 0) {
  if (!item) return defaultValue;
  
  // Try multiple possible field names
  const fieldVariations = {
    username: ['username', 'user__username', 'user_name', 'student_name'],
    email: ['email', 'user__email', 'user_email'],
    course_name: ['course_name', 'course__name', 'course__title', 'course_name', 'title'],
    duration: ['duration', 'course__duration', 'weeks', 'course_duration', 'total_weeks', 'duration_weeks'],
    study_time: ['study_time', 'study_duration', 'time_spent', 'total_study_time', 'minutes_studied'],
    progress: ['progress', 'completion_rate', 'percentage', 'completion_percentage', 'progress_percentage'],
    status: ['status', 'state', 'completion_status']
  };
  
  const variations = fieldVariations[field] || [field];
  
  for (const variation of variations) {
    if (item[variation] !== undefined && item[variation] !== null) {
      return item[variation];
    }
  }
  
  return defaultValue;
}

// Load dashboard data
// Load dashboard data
function loadDashboardData() {
  console.log("DEBUG: Starting to load dashboard data...");
  
  fetch("{% url 'admin_dashboard_data' %}")
    .then(response => {
      console.log("DEBUG: Response status:", response.status);
      if (!response.ok) {
        throw new Error('Network response was not ok: ' + response.status);
      }
      return response.json();
    })
    .then(data => {
      console.log("DEBUG: Data received:", data);
      
      // Update summary cards
      document.getElementById("total_students").innerText = data.total_students || 0;
      document.getElementById("total_courses").innerText = data.total_courses || 0;
      document.getElementById("pending_assignments").innerText = data.pending_assignments || 0;
      document.getElementById("system_health").innerText = data.system_health || 100;

      console.log("DEBUG: Summary cards updated");
      console.log("DEBUG: User study data:", data.user_study_data);

      // Update user study table
      const tbody = document.getElementById("user_study_tbody");
      
      if (!data.user_study_data || data.user_study_data.length === 0) {
        console.log("DEBUG: No user study data available");
        tbody.innerHTML = `
          <tr>
            <td colspan="5" class="px-6 py-8 text-center text-gray-500">
              <i class="fas fa-inbox text-2xl mb-2"></i>
              <p>No study data available</p>
              <p class="text-sm mt-1">Assign courses to students to see their progress</p>
            </td>
          </tr>`;
        
        // Set default values for charts when no data
        document.getElementById("avgStudyTime").innerText = "0 min";
        document.getElementById("avgCompletion").innerText = "0%";
        createEmptyCharts();
        return;
      }

      console.log(`DEBUG: Processing ${data.user_study_data.length} study records`);
      
      tbody.innerHTML = "";
      data.user_study_data.forEach((item, index) => {
        // Use safe data extraction with fallbacks
        const username = getSafeData(item, 'username', 'Unknown User');
        const email = getSafeData(item, 'email', 'No email');
        const courseName = getSafeData(item, 'course_name', 'Unnamed Course');
        const duration = getSafeData(item, 'duration', 0);
        const studyTime = getSafeData(item, 'study_time', 0);
        const progress = Math.min(getSafeData(item, 'progress', 0), 100); // Cap at 100%
        const rawStatus = getSafeData(item, 'status', 'not_started');
        
        console.log(`DEBUG: Processing record ${index}:`, { username, courseName, progress, rawStatus });
        
        // ... rest of your table rendering code ...
        // Determine status display based on progress if status field is not available
        let statusText, statusColor;
        
        if (rawStatus && rawStatus !== 'not_started') {
          // Use the status from data if available
          statusText = rawStatus.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
          statusColor = 
            rawStatus === 'completed' ? 'bg-green-100 text-green-800' :
            rawStatus === 'in_progress' ? 'bg-blue-100 text-blue-800' :
            'bg-yellow-100 text-yellow-800';
        } else {
          // Fallback to progress-based status
          statusText = progress >= 80 ? 'Completed' : 
                      progress >= 50 ? 'In Progress' : 
                      progress > 0 ? 'Started' : 'Not Started';
          statusColor = progress >= 80 ? 'bg-green-100 text-green-800' : 
                       progress >= 50 ? 'bg-blue-100 text-blue-800' : 
                       progress > 0 ? 'bg-yellow-100 text-yellow-800' : 'bg-gray-100 text-gray-800';
        }
        
        const userInitial = username.charAt(0).toUpperCase();
        
        tbody.innerHTML += `
          <tr class="hover:bg-gray-50 transition-colors">
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="flex items-center">
                <div class="w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-white font-bold text-sm mr-3">
                  ${userInitial}
                </div>
                <div>
                  <div class="font-medium text-gray-900">${username}</div>
                  <div class="text-sm text-gray-500">${email}</div>
                </div>
              </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="font-medium text-gray-900">${courseName}</div>
              <div class="text-sm text-gray-500">${duration} weeks</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-center text-sm text-gray-900">
              ${studyTime} min
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="flex items-center space-x-2">
                <div class="w-full bg-gray-200 rounded-full h-2.5">
                  <div class="bg-blue-600 h-2.5 rounded-full transition-all duration-500" style="width:${progress}%"></div>
                </div>
                <span class="text-sm font-medium text-gray-700 w-12">${progress}%</span>
              </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-center">
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusColor}">
                ${statusText}
              </span>
            </td>
          </tr>`;
      });

      // Update chart statistics
      const durations = data.user_study_data.map(item => getSafeData(item, 'study_time', 0));
      const avgDuration = durations.length > 0 ? durations.reduce((a,b) => a+b,0)/durations.length : 0;
      document.getElementById("avgStudyTime").innerText = `${Math.round(avgDuration)} min`;

      const progressValues = data.user_study_data.map(item => getSafeData(item, 'progress', 0));
      const avgProgress = progressValues.length > 0 ? progressValues.reduce((a,b) => a+b,0)/progressValues.length : 0;
      document.getElementById("avgCompletion").innerText = `${Math.round(avgProgress)}%`;

      // Update additional chart statistics
      const totalStudyTime = durations.reduce((a,b) => a+b,0);
      document.getElementById("totalStudyTime").innerText = `${Math.round(totalStudyTime)} min`;
      
      const maxStudyTime = Math.max(...durations);
      const topPerformerIndex = durations.indexOf(maxStudyTime);
      const topPerformer = topPerformerIndex !== -1 ? getSafeData(data.user_study_data[topPerformerIndex], 'username', 'Unknown') : '-';
      document.getElementById("topPerformer").innerText = topPerformer;
      
      const completionRate = (progressValues.filter(p => p >= 80).length / progressValues.length * 100).toFixed(1);
      document.getElementById("completionRate").innerText = `${completionRate}%`;
      
      const activeLearners = progressValues.filter(p => p > 0 && p < 100).length;
      document.getElementById("activeLearners").innerText = activeLearners;

      // Create charts with the data
      createCharts(data.user_study_data);
    })
    .catch(err => {
      console.error("Error loading dashboard data:", err);
      const tbody = document.getElementById("user_study_tbody");
      tbody.innerHTML = `
        <tr>
          <td colspan="5" class="px-6 py-8 text-center text-red-500">
            <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
            <p>Error loading data</p>
            <p class="text-sm mt-1">Please try refreshing the page</p>
            <button onclick="refreshData()" class="mt-2 bg-red-100 text-red-700 px-4 py-2 rounded-lg text-sm font-medium hover:bg-red-200 transition-colors">
              <i class="fas fa-sync-alt mr-2"></i>Retry
            </button>
          </td>
        </tr>`;
      
      // Set default values
      document.getElementById("avgStudyTime").innerText = "0 min";
      document.getElementById("avgCompletion").innerText = "0%";
      createEmptyCharts();
    });
}

// Create charts with actual data
function createCharts(userStudyData) {
  // Destroy existing charts if they exist
  if (studyChartInstance) {
    studyChartInstance.destroy();
  }
  if (progressChartInstance) {
    progressChartInstance.destroy();
  }

  // Study Time Chart
  const studyCtx = document.getElementById('studyChart').getContext('2d');
  const studyLabels = userStudyData.map((item, index) => {
    const username = getSafeData(item, 'username', 'User');
    return username.length > 8 ? username.substring(0, 8) + '...' : username;
  });
  const studyDurations = userStudyData.map(item => getSafeData(item, 'study_time', 0));

  studyChartInstance = new Chart(studyCtx, {
    type: 'bar',
    data: {
      labels: studyLabels,
      datasets: [{
        label: 'Study Time (min)',
        data: studyDurations,
        backgroundColor: 'rgba(67, 97, 238, 0.7)',
        borderColor: 'rgba(67, 97, 238, 1)',
        borderWidth: 1,
        borderRadius: 8,
        barPercentage: 0.6
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: { 
          beginAtZero: true,
          grid: { color: 'rgba(0,0,0,0.1)' },
          ticks: { font: { size: 11 } }
        },
        x: { 
          grid: { display: false },
          ticks: { font: { size: 11 } }
        }
      },
      plugins: {
        legend: { display: false },
        tooltip: { 
          backgroundColor: 'rgba(255,255,255,0.9)',
          titleColor: '#1f2937',
          bodyColor: '#1f2937',
          borderColor: 'rgba(0,0,0,0.1)',
          borderWidth: 1
        }
      }
    }
  });

  // Progress Distribution Chart
  const progressCtx = document.getElementById('progressChart').getContext('2d');
  
  const completed = userStudyData.filter(item => getSafeData(item, 'progress', 0) >= 80).length;
  const inProgress = userStudyData.filter(item => {
    const progress = getSafeData(item, 'progress', 0);
    return progress >= 50 && progress < 80;
  }).length;
  const started = userStudyData.filter(item => {
    const progress = getSafeData(item, 'progress', 0);
    return progress > 0 && progress < 50;
  }).length;
  const notStarted = userStudyData.filter(item => getSafeData(item, 'progress', 0) === 0).length;

  progressChartInstance = new Chart(progressCtx, {
    type: 'doughnut',
    data: {
      labels: ['Completed (80-100%)', 'In Progress (50-79%)', 'Started (1-49%)', 'Not Started (0%)'],
      datasets: [{
        data: [completed, inProgress, started, notStarted],
        backgroundColor: [
          'rgba(34, 197, 94, 0.8)',
          'rgba(59, 130, 246, 0.8)',
          'rgba(249, 115, 22, 0.8)',
          'rgba(156, 163, 175, 0.8)'
        ],
        borderWidth: 2,
        borderColor: '#fff'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      cutout: '65%',
      plugins: {
        legend: {
          position: 'bottom',
          labels: { font: { size: 11 }, padding: 15 }
        }
      }
    }
  });
}

// Create empty charts when no data is available
function createEmptyCharts() {
  // Destroy existing charts
  if (studyChartInstance) {
    studyChartInstance.destroy();
  }
  if (progressChartInstance) {
    progressChartInstance.destroy();
  }

  // Create empty study chart
  const studyCtx = document.getElementById('studyChart').getContext('2d');
  studyChartInstance = new Chart(studyCtx, {
    type: 'bar',
    data: {
      labels: ['No Data'],
      datasets: [{
        label: 'Study Time',
        data: [0],
        backgroundColor: 'rgba(156, 163, 175, 0.7)',
        borderColor: 'rgba(156, 163, 175, 1)',
        borderWidth: 1,
        borderRadius: 8
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: { beginAtZero: true }
      },
      plugins: {
        legend: { display: false }
      }
    }
  });

  // Create empty progress chart
  const progressCtx = document.getElementById('progressChart').getContext('2d');
  progressChartInstance = new Chart(progressCtx, {
    type: 'doughnut',
    data: {
      labels: ['No Data'],
      datasets: [{
        data: [1],
        backgroundColor: ['rgba(156, 163, 175, 0.8)'],
        borderWidth: 2,
        borderColor: '#fff'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      cutout: '65%',
      plugins: {
        legend: { display: false }
      }
    }
  });
}

// Refresh data function
function refreshData() {
  const refreshBtn = document.querySelector('button[onclick="refreshData()"]');
  const originalHtml = refreshBtn.innerHTML;
  refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Refreshing...';
  refreshBtn.disabled = true;

  loadDashboardData();
  
  setTimeout(() => {
    refreshBtn.innerHTML = originalHtml;
    refreshBtn.disabled = false;
  }, 1000);
}

// Toggle chart view between simple and detailed
function toggleChartView() {
  const toggleBtn = document.getElementById('chartViewToggle');
  const chartGrid = document.querySelector('.chart-grid');
  
  if (toggleBtn.innerHTML.includes('Detailed View')) {
    // Switch to detailed view
    toggleBtn.innerHTML = '<i class="fas fa-chart-simple mr-2"></i>Simple View';
    chartGrid.classList.add('detailed-view');
    
    // Increase chart height for detailed view
    document.querySelectorAll('.chart-container').forEach(container => {
      container.style.height = '380px';
    });
    
    // Update chart options for detailed view
    if (studyChartInstance) {
      studyChartInstance.options.plugins.legend.display = true;
      studyChartInstance.update();
    }
  } else {
    // Switch to simple view
    toggleBtn.innerHTML = '<i class="fas fa-chart-bar mr-2"></i>Detailed View';
    chartGrid.classList.remove('detailed-view');
    
    // Reset chart height
    document.querySelectorAll('.chart-container').forEach(container => {
      container.style.height = '280px';
    });
    
    // Update chart options for simple view
    if (studyChartInstance) {
      studyChartInstance.options.plugins.legend.display = false;
      studyChartInstance.update();
    }
  }
}

// Export charts data (placeholder function)
function exportCharts() {
  alert('Export functionality would be implemented here. This could export chart data as CSV or generate a PDF report.');
}

// Load data when page loads
document.addEventListener("DOMContentLoaded", function () {
  loadDashboardData();
});

// Auto-refresh every 30 seconds
setInterval(loadDashboardData, 30000);
</script>
</body>
</html>