<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Take Quiz: {{ quiz.title }} | StudyPortal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        
        .quiz-container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .question-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
            overflow: hidden;
        }
        
        .option-label {
            display: flex;
            align-items: center;
            padding: 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 0.5rem;
        }
        
        .option-label:hover {
            border-color: #3b82f6;
            background-color: #f8fafc;
        }
        
        .option-label.selected {
            border-color: #10b981;
            background-color: #f0fdf4;
        }
        
        .option-radio {
            display: none;
        }
        
        .custom-radio {
            width: 20px;
            height: 20px;
            border: 2px solid #d1d5db;
            border-radius: 50%;
            margin-right: 1rem;
            position: relative;
            transition: all 0.2s ease;
        }
        
        .option-label.selected .custom-radio {
            border-color: #10b981;
            background-color: #10b981;
        }
        
        .option-label.selected .custom-radio::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
        }
        
        .timer-warning {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .progress-bar {
            height: 6px;
            background-color: #e5e7eb;
            border-radius: 3px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background-color: #10b981;
            transition: width 1s ease;
        }
        
        .sidebar-link { 
            display: flex; 
            align-items: center; 
            padding: 0.75rem 1rem; 
            border-radius: 0.5rem; 
            transition: all 0.2s ease-in-out;
            margin-bottom: 0.25rem;
        }
        
        .sidebar-link:hover { 
            background-color: rgba(79, 70, 229, 0.08); 
            color: #4F46E5; 
        }
        
        .sidebar-active { 
            background-color: rgba(79, 70, 229, 0.12); 
            color: #4F46E5; 
            font-weight: 600;
            position: relative;
        }
        
        .sidebar-active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 4px;
            background-color: #4F46E5;
            border-radius: 0 4px 4px 0;
        }
        
        .stats-card {
            transition: all 0.2s ease;
            border-radius: 12px;
            overflow: hidden;
        }
        
        .stats-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.08);
        }
        
        .gradient-sidebar {
            background: linear-gradient(180deg, #4F46E5 0%, #7C73E6 100%);
        }
        
        .alert-notification {
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .pulse-warning {
            animation: pulse 2s infinite;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #4F46E5;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Fallback icon styles */
        .icon-fallback {
            display: inline-block;
            width: 20px;
            height: 20px;
            margin-right: 12px;
            text-align: center;
            font-weight: bold;
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }
            
            .sidebar.open {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0 !important;
            }
            
            .mobile-menu-btn {
                display: block;
            }
        }

        .retake-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
    </style>
</head>
<body class="bg-gray-50">

<div class="flex min-h-screen">
    <!-- Mobile Menu Button -->
    <button class="mobile-menu-btn fixed top-4 left-4 z-20 bg-indigo-600 text-white p-2 rounded-lg md:hidden" onclick="toggleMobileMenu()">
        <span class="icon-fallback">‚ò∞</span>
    </button>

    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar fixed inset-y-0 left-0 w-64 gradient-sidebar text-white shadow-xl z-10 md:translate-x-0">
        <div class="flex flex-col h-full">
            <div class="px-6 py-5 border-b border-indigo-500/30">
                <div class="flex items-center">
                    <div class="w-10 h-10 bg-white rounded-lg flex items-center justify-center mr-3">
                        <span class="text-indigo-600 font-bold text-xl">üéì</span>
                    </div>
                    <h1 class="text-xl font-bold text-white">StudyPortal</h1>
                </div>
            </div>
            
            <nav class="flex-1 px-4 py-6 space-y-1">
                <a href="{% url 'student_dashboard' %}" class="sidebar-link text-indigo-100 hover:text-white">
                    <span class="icon-fallback">üìä</span> Dashboard
                </a>
                <a href="{% url 'my_courses' %}" class="sidebar-link text-indigo-100 hover:text-white">
                    <span class="icon-fallback">üéì</span> My Courses
                </a>
                <a href="{% url 'student_quizzes' %}" class="sidebar-link sidebar-active text-white">
                    <span class="icon-fallback">üìù</span> Quizzes
                </a>
                <a href="{% url 'performance' %}" class="sidebar-link text-indigo-100 hover:text-white">
                    <span class="icon-fallback">üìà</span> Performance
                </a>
                
                <a href="{% url 'settings' %}" class="sidebar-link text-indigo-100 hover:text-white">
                    <span class="icon-fallback">‚öôÔ∏è</span> Settings
                </a>
            </nav>
            
            <div class="p-4 border-t border-indigo-500/30">
                <div class="flex items-center mb-4 px-2">
                    <div class="w-10 h-10 rounded-full bg-indigo-400 flex items-center justify-center text-white font-bold mr-3">
                        {{ user.username|first|upper }}
                    </div>
                    <div>
                        <p class="text-white font-medium text-sm">{{ user.username }}</p>
                        <p class="text-indigo-200 text-xs">Student</p>
                    </div>
                </div>
                
                <form method="post" action="{% url 'student_logout' %}">
                    {% csrf_token %}
                    <button type="submit" class="logout-btn flex items-center w-full text-indigo-200 hover:text-white py-2 px-2 rounded-lg hover:bg-indigo-500/20 transition-colors">
                        <span class="icon-fallback">üö™</span> Logout
                    </button>
                </form>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <div class="main-content flex-1 md:ml-64 p-6">
        <!-- Header -->
        <header class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">{{ quiz.title }}</h1>
                <p class="text-gray-500 mt-1">{{ quiz.description }}</p>
                {% if is_retake %}
                <div class="mt-2">
                    <span class="retake-badge px-3 py-1 rounded-full text-sm font-medium inline-flex items-center">
                        <span class="icon-fallback" style="width: 16px; height: 16px; margin-right: 4px;">üîÑ</span>
                        Retake Attempt #{{ attempt_count }}
                        {% if previous_score %}
                        - Previous: {{ previous_score|floatformat:1 }}%
                        {% endif %}
                    </span>
                </div>
                {% endif %}
            </div>
            
            <div class="flex items-center space-x-4">
                <div class="relative">
                    <button onclick="toggleDropdown()" class="profile-button flex items-center space-x-2 bg-white border border-gray-200 rounded-xl px-3 py-2 shadow-sm hover:shadow transition-all">
                        <div class="w-8 h-8 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center font-bold">
                            {{ user.username|first|upper }}
                        </div>
                        <span class="text-gray-700 font-medium hidden sm:block">{{ user.username }}</span>
                        <span class="icon-fallback" style="width: 16px; height: 16px; margin-right: 0;">‚ñº</span>
                    </button>
                    
                    <div id="profileDropdown" class="absolute right-0 mt-2 w-56 bg-white border border-gray-200 rounded-xl shadow-lg z-10 hidden">
                        <div class="px-4 py-3 border-b border-gray-100">
                            <p class="font-semibold text-gray-900">{{ user.username }}</p>
                            <p class="text-sm text-gray-500">Student Account</p>
                        </div>
                        <div class="p-2">
                            <a href="{% url 'settings' %}" class="settings-menu-item flex items-center px-3 py-2 text-gray-700 hover:bg-gray-50 rounded-lg transition-colors">
                                <span class="icon-fallback" style="margin-right: 8px;">‚öôÔ∏è</span> Settings
                            </a>
                        </div>
                        <div class="p-2 border-t border-gray-100">
                            <form method="post" action="{% url 'student_logout' %}">
                                {% csrf_token %}
                                <button type="submit" class="flex items-center w-full px-3 py-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors">
                                    <span class="icon-fallback" style="margin-right: 8px;">üö™</span> Logout
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Quiz Stats -->
        <section class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="stats-card bg-white p-6 rounded-xl shadow-sm border border-gray-100 flex items-center">
                <div class="mr-4 p-3 rounded-lg bg-indigo-50 text-indigo-600">
                    <span class="icon-fallback">‚ùì</span>
                </div>
                <div>
                    <p class="text-gray-500 text-sm">Total Questions</p>
                    <p class="text-2xl font-bold text-gray-900">{{ questions|length }}</p>
                </div>
            </div>
            
            <div class="stats-card bg-white p-6 rounded-xl shadow-sm border border-gray-100 flex items-center">
                <div class="mr-4 p-3 rounded-lg bg-green-50 text-green-600">
                    <span class="icon-fallback">‚úÖ</span>
                </div>
                <div>
                    <p class="text-gray-500 text-sm">Answered</p>
                    <p id="answered-count" class="text-2xl font-bold text-gray-900">0</p>
                </div>
            </div>
            
            <div class="stats-card bg-white p-6 rounded-xl shadow-sm border border-gray-100 flex items-center">
                <div class="mr-4 p-3 rounded-lg bg-amber-50 text-amber-600">
                    <span class="icon-fallback">‚è∞</span>
                </div>
                <div>
                    <p class="text-gray-500 text-sm">Time Limit</p>
                    <p class="text-2xl font-bold text-gray-900">{{ quiz.time_limit }} mins</p>
                </div>
            </div>

            <div class="stats-card bg-white p-6 rounded-xl shadow-sm border border-gray-100 flex items-center">
                <div class="mr-4 p-3 rounded-lg bg-blue-50 text-blue-600">
                    <span class="icon-fallback">üéØ</span>
                </div>
                <div>
                    <p class="text-gray-500 text-sm">Passing Score</p>
                    <p class="text-2xl font-bold text-gray-900">{{ quiz.passing_score }}%</p>
                </div>
            </div>
        </section>

        <!-- Quiz Container -->
        <div class="quiz-container">
            <!-- Quiz Header -->
            <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
                <div class="flex flex-col md:flex-row md:items-center justify-between mb-4">
                    <div>
                        <h2 class="text-xl font-bold text-gray-900 mb-2">Quiz Progress</h2>
                        <p class="text-gray-600">Complete all questions before time runs out</p>
                    </div>
                    <div class="flex items-center space-x-4 mt-4 md:mt-0">
                        <!-- Timer -->
                        <div id="timer" class="bg-red-50 border border-red-200 rounded-lg px-4 py-2">
                            <div class="flex items-center space-x-2">
                                <span class="icon-fallback" style="color: #dc2626; margin-right: 8px;">‚è∞</span>
                                <span id="time-display" class="text-red-600 font-bold text-lg">{{ quiz.time_limit }}:00</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Progress -->
                <div class="mb-4">
                    <div class="flex justify-between text-sm text-gray-600 mb-2">
                        <span>Progress</span>
                        <span id="progress-text">Question 1 of {{ questions|length }}</span>
                    </div>
                    <div class="progress-bar">
                        <div id="progress-fill" class="progress-fill" style="width: {% widthratio 1 questions|length 100 %}%"></div>
                    </div>
                </div>
            </div>

            <!-- Quiz Form -->
            <form id="quiz-form" method="POST" action="{% url 'take_quiz' quiz.id %}">
                {% csrf_token %}
                
                <!-- Hidden fields for time tracking -->
                <input type="hidden" id="actual-time-spent" name="actual_time_spent" value="0">
                <input type="hidden" id="quiz-start-time" name="quiz_start_time" value="">
                
                <!-- Questions Container -->
                <div id="questions-container">
                    {% for question in questions %}
                    <div class="question-card {% if forloop.first %}active{% else %}hidden{% endif %}" data-question-index="{{ forloop.counter0 }}">
                        <div class="p-6 border-b border-gray-200">
                            <div class="flex items-start justify-between">
                                <h3 class="text-xl font-semibold text-gray-900 mb-4">
                                    <span class="text-indigo-600">Q{{ forloop.counter }}.</span> 
                                    {{ question.text }}
                                </h3>
                                <span class="bg-gray-100 text-gray-600 px-3 py-1 rounded-full text-sm font-medium">
                                    {{ forloop.counter }}/{{ questions|length }}
                                </span>
                            </div>
                            
                            <!-- Options -->
                            <div class="space-y-3">
                                {% for choice in question.choices.all %}
                                <label class="option-label">
                                    <input type="radio" 
                                           name="question_{{ question.id }}" 
                                           value="{{ choice.id }}" 
                                           class="option-radio"
                                           data-question-id="{{ question.id }}">
                                    <span class="custom-radio"></span>
                                    <span class="text-gray-700">{{ choice.choice_text }}</span>
                                </label>
                                {% empty %}
                                <div class="text-red-500 p-4 bg-red-50 rounded-lg">
                                    No options available for this question.
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <!-- Navigation -->
                        <div class="p-4 bg-gray-50 flex justify-between">
                            {% if not forloop.first %}
                            <button type="button" class="prev-question-btn bg-white border border-gray-300 text-gray-700 px-6 py-2 rounded-lg hover:bg-gray-50 transition-colors flex items-center">
                                <span class="icon-fallback" style="margin-right: 8px;">‚¨ÖÔ∏è</span>
                                Previous
                            </button>
                            {% else %}
                            <div></div>
                            {% endif %}
                            
                            {% if not forloop.last %}
                            <button type="button" class="next-question-btn bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700 transition-colors flex items-center">
                                Next
                                <span class="icon-fallback" style="margin-left: 8px;">‚û°Ô∏è</span>
                            </button>
                            {% else %}
                            <button type="button" id="submit-quiz-btn" class="submit-quiz-btn bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition-colors flex items-center">
                                <span class="icon-fallback" style="margin-right: 8px;">‚úÖ</span>
                                Submit Quiz
                            </button>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </form>
                                              
                
                <!-- Questions Navigation -->
                <div class="bg-white rounded-xl shadow-sm p-6 mt-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Questions Navigation</h3>
                    <div class="grid grid-cols-5 md:grid-cols-10 gap-2">
                        {% for question in questions %}
                        <button type="button" 
                                class="question-nav-btn w-10 h-10 rounded-lg border text-sm font-medium transition-colors {% if forloop.first %}bg-indigo-600 text-white border-indigo-600{% else %}bg-white text-gray-600 border-gray-300 hover:border-indigo-400{% endif %}"
                                data-question-index="{{ forloop.counter0 }}">
                            {{ forloop.counter }}
                        </button>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Time Up Modal -->
    <div id="time-up-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl p-8 max-w-md mx-4">
            <div class="text-center">
                <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <span class="icon-fallback" style="width: 32px; height: 32px; color: #dc2626;">‚è∞</span>
                </div>
                <h3 class="text-2xl font-bold text-gray-900 mb-2">Time's Up!</h3>
                <p class="text-gray-600 mb-6">Your time for this quiz has ended. Your answers will be automatically submitted.</p>
                <button type="button" onclick="submitQuiz()" class="bg-red-600 text-white px-6 py-3 rounded-lg hover:bg-red-700 transition-colors font-medium">
                    Submit Answers
                </button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="bg-white rounded-xl p-8 max-w-md mx-4 text-center">
            <div class="loading-spinner mx-auto mb-4"></div>
            <h3 class="text-xl font-bold text-gray-900 mb-2">Submitting Quiz...</h3>
            <p class="text-gray-600">Please wait while we process your answers.</p>
        </div>
    </div>

    <script>
    // Initialize Lucide icons with error handling
    function initializeIcons() {
        try {
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
                console.log('Lucide icons initialized successfully');
            } else {
                console.warn('Lucide not available, using fallback icons');
                showFallbackIcons();
            }
        } catch (error) {
            console.error('Error initializing Lucide icons:', error);
            showFallbackIcons();
        }
    }

    // Show fallback icons if Lucide fails
    function showFallbackIcons() {
        const fallbackIcons = document.querySelectorAll('.icon-fallback');
        fallbackIcons.forEach(icon => {
            icon.style.display = 'inline-block';
        });
    }

    // Quiz state
    let currentQuestionIndex = 0;
    let totalQuestions = {{ questions|length }};
    let timeLimit = {{ quiz.time_limit }} * 60; // Convert to seconds
    let timeRemaining = timeLimit;
    let timerInterval;
    let answers = {};
    let isSubmitting = false;
    
    // TIME TRACKING VARIABLES - FIX FOR "0 SECONDS" ISSUE
    let quizStartTime = Date.now(); // Client-side start time in milliseconds
    let actualTimeSpent = 0; // Will track actual time spent
    
    // DOM elements
    const questionsContainer = document.getElementById('questions-container');
    const questionCards = document.querySelectorAll('.question-card');
    const progressFill = document.getElementById('progress-fill');
    const progressText = document.getElementById('progress-text');
    const timeDisplay = document.getElementById('time-display');
    const quizForm = document.getElementById('quiz-form');
    const timeUpModal = document.getElementById('time-up-modal');
    const answeredCountElement = document.getElementById('answered-count');
    const loadingOverlay = document.getElementById('loading-overlay');
    const submitQuizBtn = document.getElementById('submit-quiz-btn');
    
    // Hidden fields for time tracking
    const actualTimeSpentField = document.getElementById('actual-time-spent');
    const quizStartTimeField = document.getElementById('quiz-start-time');
    
    // Initialize quiz
    function initializeQuiz() {
        console.log('Quiz initialized at:', new Date().toISOString());
        
        // Initialize icons first
        initializeIcons();
        
        // Set the exact start time when quiz loads
        quizStartTime = Date.now();
        
        // Update hidden fields with timing data
        if (quizStartTimeField) {
            quizStartTimeField.value = quizStartTime.toString();
            console.log('Start time stored:', quizStartTime);
        }
        
        // Start tracking actual time spent
        setInterval(() => {
            actualTimeSpent = Math.floor((Date.now() - quizStartTime) / 1000);
            if (actualTimeSpentField) {
                actualTimeSpentField.value = actualTimeSpent;
            }
        }, 1000);
        
        startTimer();
        updateProgress();
        loadSavedAnswers();
        updateAnsweredCount();
        
        // Add event listener for submit button
        if (submitQuizBtn) {
            submitQuizBtn.addEventListener('click', handleQuizSubmission);
        }
    }
    
    // Timer functions
    function startTimer() {
        updateTimeDisplay();
        timerInterval = setInterval(() => {
            timeRemaining--;
            updateTimeDisplay();
            
            if (timeRemaining <= 0) {
                clearInterval(timerInterval);
                showTimeUpModal();
            } else if (timeRemaining <= 300) { // 5 minutes warning
                document.getElementById('timer').classList.add('timer-warning');
            }
        }, 1000);
    }
    
    function updateTimeDisplay() {
        const minutes = Math.floor(timeRemaining / 60);
        const seconds = timeRemaining % 60;
        timeDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }
    
    function showTimeUpModal() {
        timeUpModal.classList.remove('hidden');
    }
    
    // Navigation functions
    function showQuestion(index) {
        // Hide all questions
        questionCards.forEach(card => card.classList.add('hidden'));
        questionCards.forEach(card => card.classList.remove('active'));
        
        // Show selected question
        questionCards[index].classList.remove('hidden');
        questionCards[index].classList.add('active');
        
        // Update current index
        currentQuestionIndex = index;
        
        // Update progress
        updateProgress();
        
        // Update navigation buttons
        updateNavigationButtons();
    }
    
    function updateProgress() {
        const progress = ((currentQuestionIndex + 1) / totalQuestions) * 100;
        progressFill.style.width = `${progress}%`;
        progressText.textContent = `Question ${currentQuestionIndex + 1} of ${totalQuestions}`;
    }
    
    function updateNavigationButtons() {
        // Update question nav buttons
        document.querySelectorAll('.question-nav-btn').forEach((btn, index) => {
            const questionId = parseInt(btn.dataset.questionIndex);
            const isAnswered = answers[getQuestionId(questionId)] !== undefined;
            
            btn.className = `question-nav-btn w-10 h-10 rounded-lg border text-sm font-medium transition-colors ${
                index === currentQuestionIndex 
                    ? 'bg-indigo-600 text-white border-indigo-600' 
                    : isAnswered
                        ? 'bg-green-100 text-green-700 border-green-300'
                        : 'bg-white text-gray-600 border-gray-300 hover:border-indigo-400'
            }`;
        });
    }
    
    // Answer handling
    function saveAnswer(questionId, optionId) {
        answers[questionId] = optionId;
        updateNavigationButtons();
        updateAnsweredCount();
        
        // Save to localStorage
        localStorage.setItem(`quiz_{{ quiz.id }}_answers`, JSON.stringify(answers));
    }
    
    function loadSavedAnswers() {
        const saved = localStorage.getItem(`quiz_{{ quiz.id }}_answers`);
        if (saved) {
            answers = JSON.parse(saved);
            
            // Restore selected answers in UI
            Object.keys(answers).forEach(questionId => {
                const optionId = answers[questionId];
                const radio = document.querySelector(`input[name="question_${questionId}"][value="${optionId}"]`);
                if (radio) {
                    radio.checked = true;
                    radio.closest('.option-label').classList.add('selected');
                }
            });
            
            updateNavigationButtons();
            updateAnsweredCount();
        }
    }
    
    function updateAnsweredCount() {
        const answeredCount = Object.keys(answers).length;
        answeredCountElement.textContent = answeredCount;
    }
    
    function getQuestionId(index) {
        const questionCard = questionCards[index];
        const radioInputs = questionCard.querySelectorAll('.option-radio');
        if (radioInputs.length > 0) {
            return radioInputs[0].name.replace('question_', '');
        }
        return null;
    }
    
    // Event listeners
    document.querySelectorAll('.next-question-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            if (currentQuestionIndex < totalQuestions - 1) {
                showQuestion(currentQuestionIndex + 1);
            }
        });
    });
    
    document.querySelectorAll('.prev-question-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            if (currentQuestionIndex > 0) {
                showQuestion(currentQuestionIndex - 1);
            }
        });
    });
    
    document.querySelectorAll('.question-nav-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const index = parseInt(btn.dataset.questionIndex);
            showQuestion(index);
        });
    });
    
    document.querySelectorAll('.option-label').forEach(label => {
        label.addEventListener('click', () => {
            const radio = label.querySelector('.option-radio');
            const questionId = radio.dataset.questionId;
            const optionId = radio.value;
            
            // Remove selected class from all options in this question
            label.closest('.question-card').querySelectorAll('.option-label').forEach(l => {
                l.classList.remove('selected');
            });
            
            // Add selected class to clicked option
            label.classList.add('selected');
            radio.checked = true;
            
            // Save answer
            saveAnswer(questionId, optionId);
        });
    });
    
    // Quiz submission handling - FIXED TIME TRACKING
    function handleQuizSubmission() {
        console.log('=== QUIZ SUBMISSION STARTED ===');
        
        // Calculate final time spent
        const finalTimeSpent = Math.floor((Date.now() - quizStartTime) / 1000);
        console.log('Final time spent:', finalTimeSpent, 'seconds');
        
        // Ensure minimum time of 1 second
        const timeToSubmit = Math.max(1, finalTimeSpent);
        
        // Update the hidden field with actual time spent
        if (actualTimeSpentField) {
            actualTimeSpentField.value = timeToSubmit;
            console.log('Time spent field updated to:', actualTimeSpentField.value);
        }
        
        // Check if all questions are answered
        const answeredQuestions = Object.keys(answers).length;
        if (answeredQuestions < totalQuestions) {
            const confirmSubmit = confirm(`You have answered ${answeredQuestions} out of ${totalQuestions} questions. Are you sure you want to submit?`);
            if (!confirmSubmit) {
                return;
            }
        }
        
        // Set submitting flag to true
        isSubmitting = true;
        
        // Show loading overlay
        loadingOverlay.classList.remove('hidden');
        
        // Stop the timer
        if (timerInterval) {
            clearInterval(timerInterval);
        }
        
        // Add hidden inputs for answers to ensure they're submitted
        Object.keys(answers).forEach(questionId => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = `question_${questionId}`;
            input.value = answers[questionId];
            quizForm.appendChild(input);
        });
        
        // Clear saved answers from localStorage
        localStorage.removeItem(`quiz_{{ quiz.id }}_answers`);
        
        console.log('Submitting form with:', {
            answers: answers,
            timeSpent: timeToSubmit,
            startTime: quizStartTime
        });
        
        // Submit the form after a short delay to show loading state
        setTimeout(() => {
            quizForm.submit();
        }, 1500);
    }
    
    // Auto-submit when time is up
    window.submitQuiz = function() {
        console.log('Auto-submit triggered by timer');
        isSubmitting = true;
        handleQuizSubmission();
    };
    
    // Initialize quiz when page loads
    document.addEventListener('DOMContentLoaded', initializeQuiz);
    
    // Warn before leaving page - but not when submitting
    window.addEventListener('beforeunload', function(e) {
        if (Object.keys(answers).length > 0 && !isSubmitting) {
            e.preventDefault();
            e.returnValue = '';
        }
    });

    // UI interaction functions
    function toggleDropdown() {
        document.getElementById("profileDropdown").classList.toggle("hidden");
    }
    
    function toggleMobileMenu() {
        document.getElementById("sidebar").classList.toggle("open");
    }
    
    // Close dropdown when clicking outside
    window.onclick = function(event) {
        if (!event.target.matches('.profile-button') && !event.target.closest('.profile-button')) {
            const dropdown = document.getElementById("profileDropdown");
            if (!dropdown.classList.contains('hidden')) {
                dropdown.classList.add('hidden');
            }
        }
    }

    // Event handlers for interactive elements
    document.addEventListener('DOMContentLoaded', function() {
        // Close dropdown when clicking on menu items
        document.querySelectorAll('#profileDropdown a, #profileDropdown button').forEach(item => {
            item.addEventListener('click', function() {
                document.getElementById("profileDropdown").classList.add("hidden");
            });
        });
    });

    // Debug function to check what's happening
    function debugSubmission() {
        console.log('=== DEBUG INFO ===');
        console.log('Answers:', answers);
        console.log('isSubmitting:', isSubmitting);
        console.log('Quiz start time:', quizStartTime);
        console.log('Actual time spent:', actualTimeSpent);
        console.log('Time spent field value:', actualTimeSpentField ? actualTimeSpentField.value : 'Not found');
        console.log('Start time field value:', quizStartTimeField ? quizStartTimeField.value : 'Not found');
    }

    // Add debug button (remove in production)
    
</script>
</body>
</html>